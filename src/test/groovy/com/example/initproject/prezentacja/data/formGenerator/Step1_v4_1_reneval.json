{
  "formId": "FORM_ID_IDENTYFIKACJA",
  "version": "4.1.0",
  "formName": "formularzIdentyfikacyjny",
  "schema": {
    "identityMethod": {
      "label": "Wybierz metodę identyfikacji",
      "type": "string",
      "possibleOptions": [
        "PESEL/NIP/REGON",
        "Data urodzenia"
      ],
      "defaultValue": "PESEL/NIP/REGON",
      "visible": true,
      "editable": true
    },
    "birthDate": {
      "label": "Data urodzenia",
      "type": "string",
      "defaultValue": "",
      "validators": {
        "regex": {
          "use": "regexDate"
        }
      }
    },
    "nationalId": {
      "label": "PESEL / NIP / REGON",
      "type": "string",
      "defaultValue": "",
      "validators": {
        "regex": {
          "use": "regexPeselNipRegon"
        }
      }
    },
    "noVehicle": {
      "label": "Nie mam jeszcze pojazdu",
      "type": "boolean",
      "defaultValue": false
    },
    "vinNumber": {
      "label": "Numer VIN",
      "type": "string",
      "defaultValue": "",
      "validators": {
        "regex": {
          "use": "regexVin"
        }
      }
    },
    "registrationNumber": {
      "label": "Numer rejestracyjny",
      "type": "string",
      "defaultValue": "",
      "validators": {
        "regex": {
          "use": "regexPlate"
        }
      }
    }
  },
  "groups": {
    "identity": {
      "label": "Dane identyfikacyjne",
      "fields": [
        "identityMethod",
        "birthDate",
        "nationalId"
      ],
      "visible": true
    },
    "vehicle": {
      "label": "Dane pojazdu",
      "fields": [
        "vinNumber",
        "registrationNumber"
      ],
      "visible": true,
      "validators": {
        "anyFieldFilled": {
          "use": "anyFieldFilledVehicle"
        }
      }
    }
  },
  "actions": [
    {
      "when": {
        "field": "identityMethod",
        "operator": "EQUAL",
        "value": "Data urodzenia"
      },
      "actions": [
        {
          "target": "birthDate",
          "properties": {
            "visible": true,
            "validators": {
              "required": {
                "operator": "add"
              }
            }
          }
        },
        {
          "target": "nationalId",
          "properties": {
            "visible": false,
            "validators": {
              "required": {
                "operator": "delete"
              }
            }
          }
        }
      ]
    },
    {
      "when": {
        "field": "identityMethod",
        "operator": "EQUAL",
        "value": "PESEL/NIP/REGON"
      },
      "actions": [
        {
          "target": "nationalId",
          "properties": {
            "visible": true,
            "validators": {
              "required": {
                "operator": "add"
              }
            }
          }
        },
        {
          "target": "birthDate",
          "properties": {
            "visible": false,
            "validators": {
              "required": {
                "operator": "delete"
              }
            }
          }
        }
      ]
    },
    {
      "when": {
        "field": "noVehicle",
        "operator": "EQUAL",
        "value": true
      },
      "actions": [
        {
          "target": "group.vehicle",
          "properties": {
            "visible": false,
            "validators": {
              "required": {
                "operator": "delete"
              }
            }
          }
        }
      ]
    },
    {
      "when": {
        "operator": "AND",
        "conditions": [
          {
            "field": "vinNumber",
            "operator": "EQUAL",
            "value": ""
          },
          {
            "field": "registrationNumber",
            "operator": "EQUAL",
            "value": ""
          }
        ]
      },
      "actions": [
        {
          "target": "vinNumber",
          "properties": {
            "validators": {
              "required": {
                "operator": "add"
              }
            }
          }
        },
        {
          "target": "registrationNumber",
          "properties": {
            "validators": {
              "required": {
                "operator": "add"
              }
            }
          }
        }
      ]
    },
    {
      "when": {
        "operator": "OR",
        "conditions": [
          {
            "field": "vinNumber",
            "operator": "NOT_EQUAL",
            "value": ""
          },
          {
            "field": "registrationNumber",
            "operator": "NOT_EQUAL",
            "value": ""
          }
        ]
      },
      "actions": [
        {
          "target": "vinNumber",
          "properties": {
            "validators": {
              "required": {
                "operator": "delete"
              }
            }
          }
        },
        {
          "target": "registrationNumber",
          "properties": {
            "validators": {
              "required": {
                "operator": "delete"
              }
            }
          }
        }
      ]
    },
    {
      "when": {
        "field": "example",
        "operator": "EQUAL",
        "value": "SPECIAL_CASE",
        "regex" : {
          "operator": "add",
          "use": "regexNew"
        },
        "min": {
          "operator": "add",
          "use": "minExample"
        }
      },
      "actions": [
        {
          "target": "vinNumber",
          "properties": {
            "validators": {
              "regexVin": {
                "operator": "remove"
              },
              "regexNew": {
                "operator": "add"
              }
            }
          }
        }
      ]
    }
  ],
  "prefillContextRules": [
    {
      "when": {
        "field": "birthDate",
        "operator": "NOT_EQUAL",
        "value": ""
      },
      "actions": [
        {
          "target": "identityMethod",
          "properties": {
            "defaultValue": "Data urodzenia"
          }
        }
      ]
    },
    {
      "when": {
        "field": "nationalId",
        "operator": "NOT_EQUAL",
        "value": ""
      },
      "actions": [
        {
          "target": "identityMethod",
          "properties": {
            "defaultValue": "PESEL/NIP/REGON"
          }
        }
      ]
    }
  ],
  "contextualRules": [
    {
      "when": {
        "field": "ctx.channel",
        "operator": "EQUAL",
        "value": "RENEWAL"
      },
      "actions": [
        {
          "target": "*",
          "properties": {
            "editable": false
          }
        }
      ],
      "priority": "override"
    },
    {
      "when": {
        "field": "ctx.channel",
        "operator": "EQUAL",
        "value": "NEW_BUSINESS"
      },
      "actions": []
    }
  ],
  "regexPatterns": {
    "vin": "^[A-HJ-NPR-Z0-9]{17}$",
    "pesel": "^\\d{11}$",
    "date": "^\\d{4}-\\d{2}-\\d{2}$",
    "plate": "^[A-Z0-9]{5,10}$"
  },

  "validators": {
    "regex": {
      "valiRegexVin": {
        "patternRef": "regexVin"
      },
      "valiRegexPesel": {
        "patternRef": "regexPesel"
      },
      "valiRegexDate": {
        "patternRef": "regexDate"
      },
      "valiRegexPlate": {
        "patternRef": "regexPlate"
      }
    },
    "predicate": {
      "valiChecksumVin": {
        "name": "validateVinChecksum"
      },
      "valiChecksumPesel": {
        "name": "validatePeselChecksum"
      }
    },
    "min": {
      "valiMinAge18": {
        "value": 18
      }
    },
    "max": {
      "valiMaxAge100": {
        "value": 100,
        "inclusive": true
      }
    },
    "composite": {
      "valiValidVin": {
        "items": ["valiRegexVin", "valiChecksumVin"]
      },
      "valiValidPesel": {
        "items": ["valiRegexPesel", "valiChecksumPesel"]
      }
    },
    "group": {
      "valiAnyVehicle": {
        "message": "Uzupełnij VIN lub numer rejestracyjny"
      }
    }
  },


  "regexPatterns": {
    "regexVin": "^[A-HJ-NPR-Z0-9]{17}$",
    "regexPesel": "^\\d{11}$",
    "regexDate": "^\\d{4}-\\d{2}-\\d{2}$",
    "regexPlate": "^[A-Z0-9]{5,10}$"
  },

  "validators": {
    "regex": {
      "valiRegexVin": {
        "patternRef": "regexVin"
      },
      "valiRegexPesel": {
        "patternRef": "regexPesel"
      },
      "valiRegexDate": {
        "patternRef": "regexDate"
      },
      "valiRegexPlate": {
        "patternRef": "regexPlate"
      }
    },
    "predicate": {
      "valiChecksumVin": {
        "name": "validateVinChecksum" -> (Do BE)
      },
      "valiChecksumPesel": {
        "name": "validatePeselChecksum"
      }
    },
    "min": {
      "valiMinAge18": {
        "value": 18
      }
    },
    "max": {
      "valiMaxAge100": {
        "value": 100,
        "inclusive": true
      }
    },
    "composite": {
      "valiValidVin": {
        "items": ["valiRegexVin", "valiChecksumVin"]
      },
      "valiValidPesel": {
        "items": ["valiRegexPesel", "valiChecksumPesel"]
      }
    },
    "group": {
      "valiAnyVehicle": {
        "message": "Uzupełnij VIN lub numer rejestracyjny"
      }
    }
  }
}